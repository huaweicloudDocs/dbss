# 无法使用数据库安全审计<a name="ZH-CN_TOPIC_0143651392"></a>

## 故障现象<a name="section4597163713358"></a>

触发数据库流量后，在SQL语句列表页面搜索执行的语句，不能搜索到相关的审计信息。

## 可能原因<a name="section12392122314367"></a>

-   待审计的数据库信息有误
-   待审计的数据库未开启审计功能
-   待审计的数据库不在审计范围内
-   Agent程序没有运行
-   Agent与数据库安全审计实例之间通信异常

## 处理步骤<a name="section20158847143620"></a>

1.  [登录管理控制台](https://console.huaweicloud.com/)。
2.  进入数据库列表入口，如[图1](#zh-cn_topic_0145057233_zh-cn_topic_0208809337_zh-cn_topic_0144723368_fig4155162273613)所示。

    **图 1**  进入数据库列表入口<a name="zh-cn_topic_0145057233_zh-cn_topic_0208809337_zh-cn_topic_0144723368_fig4155162273613"></a>  
    ![](figures/进入数据库列表入口.png "进入数据库列表入口")

3.  检查数据库信息是否正确以及数据库的审计是否已开启。
    1.  查看数据库信息，如[图2](#fig18191942155913)所示。

        **图 2**  查看待审计的数据库信息<a name="fig18191942155913"></a>  
        ![](figures/查看待审计的数据库信息.png "查看待审计的数据库信息")

    2.  检查数据库信息是否正确。
        -   如果数据库信息正确，请执行[3.c](#li15451941216)。
        -   如果数据库信息错误，请先单击“删除“，删除该数据库，再单击“添加数据库“，重新添加该数据库。
            -   如果问题已解决，结束操作。
            -   如果问题仍存在，请执行[3.c](#li15451941216)。

    3.  <a name="li15451941216"></a>检查数据库的审计是否已开启。
        -   如果“审计状态“为“已开启“，请执行[4](#li207461824135718)。
        -   如果“审计状态“为“已关闭“，请单击“开启“，开启数据库审计。
            -   如果问题已解决，结束操作。
            -   如果问题仍存在，请执行[4](#li207461824135718)。


4.  <a name="li207461824135718"></a>检查审计范围中对应数据库是否已启用。

    在左侧导航树中，选择“数据库安全审计  \>  审计规则“，进入审计范围列表页面，如[图3](#fig17324536122612)所示。

    **图 3**  查看审计范围信息<a name="fig17324536122612"></a>  
    ![](figures/查看审计范围信息.png "查看审计范围信息")

    -   如果“状态“为“已启用“，请执行[5](#li56931138113110)。
    -   如果“状态“为“已禁用“，请单击“启用“，启用数据库对应的审计范围规则。
        -   如果问题已解决，结束操作。
        -   如果问题仍存在，请执行[5](#li56931138113110)。

5.  <a name="li56931138113110"></a>检查数据库的Agent程序运行状态。
    1.  使用跨平台远程访问工具（例如PuTTY）以**root**用户通过SSH方式，登录Agent的安装节点。
    2.  执行以下命令，查看Agent程序的运行状态。

        **ps** **-ef|grep** **audit\_agent**

        -   如果界面回显以下信息，说明Agent程序运行正常，请执行[7](#li18109152112438)。

            ```
            /opt/dbss_audit_agent/bin/audit_agent
            ```

        -   如果界面无回显信息，说明Agent程序运行异常，请执行[6](#li10382244413)。

6.  <a name="li10382244413"></a>执行以下命令，重新启动Agent。

    **service** **audit\_agent** **restart**

    -   如果问题已解决，结束操作。
    -   如果问题仍存在，请执行[7](#li18109152112438)。

7.  <a name="li18109152112438"></a>执行以下命令，检查Agent与数据库安全审计实例之间的通信状态。

    **tailf** **/opt/dbss\_audit\_agent/log/audit\_agent.log**

    -   如果界面回显类似以下信息，说明Agent与数据库安全审计实例之间通信正常，请执行[10](#li13201153174214)。

        **图 4**  通信正常<a name="fig123204818207"></a>  
        ![](figures/通信正常.png "通信正常")

    -   如果界面回显类似以下信息，说明Agent与数据库安全审计实例之间通信异常，请执行[8](#li5155144195013)。

        **图 5**  通信异常<a name="fig8492132411531"></a>  
        ![](figures/通信异常.png "通信异常")

8.  <a name="li5155144195013"></a>检查数据库安全审计实例安全组规则。
    1.  进入数据库安全服务管理界面。
    2.  记录待审计的数据库安装节点IP地址。
        1.  在左侧导航树中，选择“数据库安全审计  \>  数据库列表“，进入数据库列表页面。
        2.  在“实例列表“下拉列表框中选择数据库所在的实例。
        3.  单击数据库左侧的![](figures/icon-drop.png)展开Agent的详细信息，并记录“安装节点IP“，如[图6](#fig394152215213)所示。

            **图 6**  记录安装节点IP信息<a name="fig394152215213"></a>  
            ![](figures/记录安装节点IP信息.png "记录安装节点IP信息")

    3.  记录待审计的数据库所在的安全组信息。
        1.  在左侧导航树中，选择“数据库安全审计  \>  实例列表“，进入实例列表界面。
        2.  单击需要处理的实例名称，进入实例概览页面。
        3.  在“网络配置信息“区域，记录数据库安全审计实例的“安全组“（例如Sys-default），如[图7](#fig1848815282)所示。

            **图 7**  获取数据库安全审计实例所在的安全组<a name="fig1848815282"></a>  
            ![](figures/获取数据库安全审计实例所在的安全组.png "获取数据库安全审计实例所在的安全组")

    4.  进入安全组的规则页面。
        1.  单击管理控制台上方的“服务列表“，选择“网络  \>  虚拟私有云 VPC“，进入虚拟私有云列表界面。
        2.  在左侧导航树中，选择“访问控制  \>  安全组“，进入安全组列表界面。
        3.  在列表右上方的搜索框中输入安全组“Sys-default“后，单击![](figures/icon-search.png)或按“Enter“，列表显示“Sys-default“安全组信息。
        4.  单击“Sys-default“，进入“入方向规则“页面。

    5.  检查“Sys-default“安全组的入方向规则。

        请检查该安全组的入方向规则是否已为[图6](#fig394152215213)中的安装节点IP配置了TCP协议（端口为8000）和UDP协议（端口为7000-7100）规则。

        -   如果该安全组已配置安装节点的入方向规则，请执行[10](#li13201153174214)。
        -   如果该安全组未配置安装节点的入方向规则，请执行[9](#li9281314163318)。

9.  <a name="li9281314163318"></a>为安装节点添加入方向安全规则。
    1.  在入方向规则页面，单击“添加规则“，如[图8](#fig1300102219912)所示。

        **图 8**  添加规则<a name="fig1300102219912"></a>  
        ![](figures/添加规则.png "添加规则")

    2.  在“添加入方向规则“对话框中，为[图6](#fig394152215213)中的安装节点IP添加TCP协议（端口为8000）和UDP协议（端口为7000-7100）规则，如[图9](#fig1130116226910)所示。

        **图 9** “添加入方向规则“对话框<a name="fig1130116226910"></a>  
        ![](figures/添加入方向规则对话框.png "添加入方向规则对话框")

    3.  单击“确定“，完成添加入方向规则。

10. <a name="li13201153174214"></a>在数据库中输入一条SQL语句后，在SQL语句列表页面搜索执行的语句。
    -   如果可以搜索到输入的SQL语句信息，说明问题已解决。
    -   如果不能搜索到输入的SQL语句信息，说明问题仍存在，请联系技术支持。


